#!/bin/sh

# Exit immediately if a command exits with a non-zero status
set -e

# Handle Ctrl+C and other interrupts
trap 'echo "\n‚ùå Pre-commit hook interrupted. Aborting commit."; exit 1' INT TERM

echo "üîç Running pre-commit hook..."

# Get all staged Dart files (grep returns non-zero if no matches, so we need to handle that)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=d | grep '\.dart$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo "‚úÖ No Dart files to check."
    echo "üéâ Pre-commit hook completed successfully!"
    exit 0
fi

COUNT=$(printf "%s\n" "$STAGED_FILES" | wc -l | tr -d ' ')
echo "üìù Found ${COUNT} Dart file(s) to process..."

# Check file line counts
echo "üìè Checking file sizes avoiding bloated files..."
EXCEEDED_FILES=""
printf "%s\n" "$STAGED_FILES" | while IFS= read -r file; do
    [ -n "$file" ] || continue
    LINE_COUNT=$(wc -l < "$file" | tr -d ' ')
    if [ "$LINE_COUNT" -gt 500 ]; then
        echo "‚ö†Ô∏è  $file has $LINE_COUNT lines (exceeds 500 line limit)"
        EXCEEDED_FILES="${EXCEEDED_FILES}${file}\n"
    fi
done

if [ -n "$EXCEEDED_FILES" ]; then
    echo "‚ùå Some files exceed the 500 line limit. Please refactor before committing."
    exit 1
fi

# Format only the staged files first to avoid formatting unrelated files
echo "üé® Formatting staged Dart files..."
printf "%s\n" "$STAGED_FILES" | while IFS= read -r file; do
    [ -n "$file" ] || continue
    dart format "$file"
done

# Apply automatic fixes to staged files
echo "üîß Applying automatic fixes to staged files..."
dart fix --apply

# Run analysis on the whole project
echo "üîç Running analysis..."
flutter analyze

if [ $? -ne 0 ]; then
    echo "‚ùå Analysis failed. Please fix the issues before committing."
    exit 1
fi

# Check if staged files have passing tests
echo "üß™ Checking tests for staged files..."
TEMP_TEST_FILES=$(mktemp)
TEMP_FAILED_TESTS=$(mktemp)
TEMP_MISSING_TESTS=$(mktemp)

# Patterns to exclude from test requirements (same as coverage-check)
should_skip_test_check() {
    file="$1"
    
    # Exclude patterns
    case "$file" in
        lib/core/*) return 0 ;;
        lib/main.dart) return 0 ;;
        lib/data/services/logger_service.dart) return 0 ;;
        lib/data/providers/feature_flags_provider.dart) return 0 ;;
        lib/ui/dev_helper/*) return 0 ;;
        */fake_*) return 0 ;;
        */base_*) return 0 ;;
        *.g.dart) return 0 ;;
        *.freezed.dart) return 0 ;;
        *.mocks.dart) return 0 ;;
        test/*) return 0 ;;
    esac
    return 1
}

printf "%s\n" "$STAGED_FILES" | while IFS= read -r file; do
    [ -n "$file" ] || continue
    
    # Skip excluded files
    if should_skip_test_check "$file"; then
        continue
    fi
    
    # Convert lib/path/file.dart to test/path/file_test.dart
    test_file=$(echo "$file" | sed 's|^lib/|test/|' | sed 's|\.dart$|_test.dart|')
    
    if [ -f "$test_file" ]; then
        echo "$test_file" >> "$TEMP_TEST_FILES"
    else
        echo "‚ùå No test file found for: $file"
        echo "   Expected: $test_file"
        echo "$file" >> "$TEMP_MISSING_TESTS"
    fi
done

# Check if any files are missing tests
if [ -s "$TEMP_MISSING_TESTS" ]; then
    echo ""
    echo "‚ùå Some staged Dart files are missing corresponding tests."
    echo "Files without tests:"
    cat "$TEMP_MISSING_TESTS" | while IFS= read -r missing_file; do
        [ -n "$missing_file" ] || continue
        echo "   - $missing_file"
    done
    rm -f "$TEMP_TEST_FILES" "$TEMP_FAILED_TESTS" "$TEMP_MISSING_TESTS"
    exit 1
fi

if [ -s "$TEMP_TEST_FILES" ]; then
    echo "üèÉ Running tests for staged files..."
    
    # Get unique test files and run them
    sort -u "$TEMP_TEST_FILES" | while IFS= read -r test_file; do
        [ -n "$test_file" ] || continue
        echo "  Testing: $test_file"
        
        # Run test and fail on non-zero exit status
        if ! flutter test "$test_file" --reporter=compact; then
            echo "$test_file" >> "$TEMP_FAILED_TESTS"
            echo "  ‚ùå Tests failed for: $test_file"
        fi
    done
    
    # Check if any tests failed
    if [ -s "$TEMP_FAILED_TESTS" ]; then
        echo ""
        echo "‚ùå Some tests failed. Please fix them before committing."
        echo "Failed test files:"
        cat "$TEMP_FAILED_TESTS" | while IFS= read -r failed_file; do
            echo "   - $failed_file"
        done
        rm -f "$TEMP_TEST_FILES" "$TEMP_FAILED_TESTS" "$TEMP_MISSING_TESTS"
        exit 1
    fi
    
    echo "‚úÖ All tests passed!"
fi

rm -f "$TEMP_TEST_FILES" "$TEMP_FAILED_TESTS" "$TEMP_MISSING_TESTS"

# Re-stage all the originally staged Dart files (they may have been formatted/fixed)
echo "üì¶ Re-staging formatted and fixed files..."
printf "%s\n" "$STAGED_FILES" | while IFS= read -r file; do
    [ -n "$file" ] || continue
    git add -- "$file"
done

echo "‚úÖ All checks passed!"
echo "üéâ Pre-commit hook completed successfully!"